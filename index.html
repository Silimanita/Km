<!DOCTYPE html>
<html lang="es">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Kilometraje del Coche</title>
    <style>
        body {font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;margin:0;padding:20px;display:flex;justify-content:center;align-items:flex-start;}
        .container {background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,0.1);max-width:1200px;width:100%;animation:slideIn 0.6s ease-out;}
        @keyframes slideIn {from{opacity:0;transform:translateY(30px);}to{opacity:1;transform:translateY(0);}}
        h1 {text-align:center;color:#333;margin-bottom:30px;font-size:2.2em;background:linear-gradient(45deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .controls {background:#f8f9fa;padding:20px;border-radius:15px;margin-bottom:25px;border:2px solid #e9ecef;}
        .input-group {display:flex;flex-wrap:wrap;gap:15px;align-items:center;margin-bottom:15px;}
        .input-group label {font-weight:600;color:#495057;min-width:120px;}
        .input-group input {padding:10px 15px;border:2px solid #dee2e6;border-radius:8px;font-size:14px;transition:all 0.3s ease;min-width:150px;}
        /* Ajuste de los campos para que se vean mejor */
        .input-group .km-input { min-width: 110px; }
        .input-group .km-label { min-width: 90px; }
        .input-group .km-row { display: flex; align-items: center; gap: 15px; }
        .input-group input:focus {outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);}
        .buttons {display:flex;gap:10px;flex-wrap:wrap;}
        button {background:linear-gradient(45deg,#667eea,#764ba2);color:white;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s ease;}
        button:hover {transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,0.4);}
        .btn-secondary {background:linear-gradient(45deg,#6c757d,#495057);}
        .btn-danger {background:linear-gradient(45deg,#dc3545,#c82333);}
        .table-container {background:white;border-radius:15px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,0.1);border:1px solid #e9ecef;}
        table {width:100%;border-collapse:collapse;font-size:14px;}
        th {background:linear-gradient(45deg,#667eea,#764ba2);color:white;padding:15px 10px;text-align:center;font-weight:600;font-size:13px;}
        td {padding:12px 10px;text-align:center;border-bottom:1px solid #f1f3f4;transition:background-color 0.2s ease;}
        tr:nth-child(even){background-color:#f8f9fa;} tr:hover{background-color:#e3f2fd;}
        .number {font-family:'Courier New',monospace;font-weight:600;}
        .total-row {background:linear-gradient(45deg,#28a745,#20c997)!important;color:white;font-weight:bold;}
        .summary {background:#f8f9fa;padding:20px;border-radius:15px;margin-top:20px;border:2px solid #e9ecef;}
        .summary h3 {color:#495057;margin-bottom:15px;font-size:1.3em;}
        .summary-item {display:flex;justify-content:space-between;margin-bottom:8px;padding:5px 0;border-bottom:1px solid #dee2e6;}
        .summary-value {font-weight:600;color:#667eea;}
        .small-btn {padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer;min-width:60px;}
        .btn-edit {background:linear-gradient(45deg,#ffc107,#e0a800);color:#000;border:none;}
        .btn-delete {background:linear-gradient(45deg,#dc3545,#c82333);color:white;border:none;}
        @media(max-width:768px){.container{padding:20px;}.input-group{flex-direction:column;}.input-group .km-row { flex-direction: column; } }
        .alert {background:#d4edda;color:#155724;padding:10px 15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #28a745;display:none;}
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Control de Kilometraje del Coche</h1>
        <div id="loadAlert" class="alert"></div>
        <div class="controls">
            <div class="input-group">
                <label>Mes/A√±o:</label>
                <input type="month" id="mesAnio">
                <div class="km-row">
                    <label class="km-label">KM inicial del mes:</label>
                    <input type="text" id="kmInicial" class="km-input" placeholder="Ej: 50.000">
                </div>
                <div class="km-row">
                    <label class="km-label">KM final de hoy:</label>
                    <input type="text" id="kmFinalHoy" class="km-input" inputmode="numeric" pattern="[0-9]*" placeholder="Ej: 14.500 (opcional)">
                </div>
            </div>
            <div class="input-group">
                <label>D√≠a:</label>
                <input type="number" id="dia" min="1" max="31" placeholder="D√≠a">
                <label>Ruta realizada:</label>
                <input type="text" id="ruta" placeholder="Ej: Candelaria">
                <label>KM recorridos:</label>
                <input type="text" id="kmRecorridos" inputmode="numeric" pattern="[0-9]*" placeholder="Ej: 150">
            </div>
            <div class="buttons">
                <button onclick="agregarRegistro()">‚ûï Agregar Registro</button>
                <button onclick="guardarDatos()" class="btn-secondary">üíæ Guardar datos</button>
                <button onclick="limpiarTabla()" class="btn-danger">üóëÔ∏è Limpiar Todo</button>
            </div>
        </div>
        <div class="table-container">
            <table id="tablaKm">
                <thead><tr><th>D√≠a</th><th>Ruta Realizada</th><th>KM Recorridos</th><th>KM Total del Coche</th><th>Acciones</th></tr></thead>
                <tbody id="cuerpoTabla"></tbody>
            </table>
        </div>
        <div class="summary">
            <h3>üìà Resumen del Mes</h3>
            <div class="summary-item"><span>Total KM recorridos en el mes:</span><span class="summary-value" id="totalKmMes">0 km</span></div>
            <div class="summary-item"><span>KM inicial del coche:</span><span class="summary-value" id="kmInicialMes">0 km</span></div>
            <div class="summary-item"><span>KM final estimado del coche:</span><span class="summary-value" id="kmFinalMes">0 km</span></div>
            <div class="summary-item"><span>N√∫mero de viajes registrados:</span><span class="summary-value" id="numeroViajes">0</span></div>
        </div>
    </div>
    <script>
        let registros = [], kmInicialDelMes = 0;

        const formatNumber = num => {
            if (num == null) return '0';
            const sign = Number(num) < 0 ? '-' : '';
            const n = Math.abs(Math.round(Number(num)));
            return sign + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        const parseInputValue = v => {
            if (!v) return 0;
            const s = String(v).trim();
            const sign = s.startsWith('-') ? '-' : '';
            const digits = s.replace(/[^0-9]/g, '');
            return digits ? parseInt(sign + digits, 10) : 0;
        };

        function guardarDatos() {
            const mesAnio = document.getElementById('mesAnio').value;
            const savedData = {
                mesAnio: mesAnio,
                kmInicial: kmInicialDelMes,
                registros: registros
            };
            localStorage.setItem('controlKmData', JSON.stringify(savedData));
            const alert = document.getElementById('loadAlert');
            alert.textContent = '‚úÖ Datos guardados en el navegador correctamente.';
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        function cargarDatos() {
            const savedData = localStorage.getItem('controlKmData');
            if (savedData) {
                try {
                    const datos = JSON.parse(savedData);
                    registros = datos.registros || [];
                    kmInicialDelMes = datos.kmInicial || 0;
                    document.getElementById('mesAnio').value = datos.mesAnio || new Date().toISOString().slice(0, 7);
                    document.getElementById('kmInicial').value = formatNumber(kmInicialDelMes);
                    actualizarTabla();
                    actualizarResumen();
                    const alert = document.getElementById('loadAlert');
                    alert.textContent = '‚úÖ Datos cargados correctamente del navegador';
                    alert.style.display = 'block';
                    setTimeout(() => {
                        alert.style.display = 'none';
                    }, 3000);
                } catch (e) {
                    console.error("Error al cargar datos de localStorage:", e);
                }
            }
        }

        const addInputFormatter = (id, max = null) => {
            const input = document.getElementById(id);
            input.addEventListener('input', () => {
                let raw = input.value.replace(/\./g, '');
                if (raw === '') {
                    input.value = '';
                    return;
                }
                let num = parseInt(raw.replace(/[^0-9]/g, ''), 10);
                if (isNaN(num)) {
                    input.value = '';
                    return;
                }
                if (max !== null && num > max) {
                    alert(`El valor m√°ximo permitido es ${max}.`);
                    input.value = '';
                    return;
                }
                input.value = formatNumber(num);
            });
        };

        const addKmFinalFormatter = () => {
            const input = document.getElementById('kmFinalHoy');
            input.addEventListener('input', () => {
                let raw = input.value.replace(/\./g, '');
                if (raw === '') {
                    input.value = '';
                    document.getElementById('kmRecorridos').value = '';
                    return;
                }
                let num = parseInt(raw.replace(/[^0-9]/g, ''), 10);
                if (isNaN(num)) {
                    input.value = '';
                    return;
                }
                input.value = formatNumber(num);
            });
            input.addEventListener('blur', () => {
                if (input.value.trim()) {
                    calcularKmRecorridos();
                }
            });
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    calcularKmRecorridos();
                }
            });
        };

        addInputFormatter('kmInicial');
        addInputFormatter('kmRecorridos', 999);
        addKmFinalFormatter();

        const diaInput = document.getElementById('dia');
        diaInput.addEventListener('input', () => {
            let n = parseInt(diaInput.value.replace(/[^0-9]/g, ''), 10);
            if (isNaN(n)) {
                diaInput.value = '';
                return;
            }
            if (n < 1 || n > 31) {
                alert('El d√≠a debe estar entre 1 y 31.');
                diaInput.value = '';
                return;
            }
            diaInput.value = n;
        });

        function calcularKmRecorridos() {
            const kmFinalHoy = parseInputValue(document.getElementById('kmFinalHoy').value);
            const kmInicial = parseInputValue(document.getElementById('kmInicial').value);

            if (!kmInicial && registros.length === 0) {
                 alert('Por favor, introduce primero el KM inicial del mes.');
                 document.getElementById('kmFinalHoy').value = '';
                 return;
            }
            
            if (kmInicial && kmInicialDelMes === 0) {
                 kmInicialDelMes = kmInicial;
            }

            if (!kmFinalHoy) {
                return;
            }

            const totalRecorrido = registros.reduce((sum, r) => sum + r.kmRecorridos, 0);
            const kmActualAcumulado = kmInicialDelMes + totalRecorrido;

            if (kmFinalHoy <= kmActualAcumulado) {
                alert(`El KM final de hoy (${formatNumber(kmFinalHoy)}) debe ser mayor que el acumulado actual (${formatNumber(kmActualAcumulado)}).`);
                document.getElementById('kmFinalHoy').value = '';
                document.getElementById('kmRecorridos').value = '';
                return;
            }

            const kmRecorridosHoy = kmFinalHoy - kmActualAcumulado;

            if (kmRecorridosHoy > 999) {
                alert(`Los KM recorridos calculados (${formatNumber(kmRecorridosHoy)}) exceden el m√°ximo permitido de 999 km.`);
                document.getElementById('kmFinalHoy').value = '';
                document.getElementById('kmRecorridos').value = '';
                return;
            }

            document.getElementById('kmRecorridos').value = formatNumber(kmRecorridosHoy);
            document.getElementById('kmFinalHoy').value = '';
        }

        function agregarRegistro() {
            const dia = parseInt(document.getElementById('dia').value, 10);
            const ruta = document.getElementById('ruta').value.trim();
            const kmRec = parseInputValue(document.getElementById('kmRecorridos').value);
            const kmIni = parseInputValue(document.getElementById('kmInicial').value);

            if (!dia || dia < 1 || dia > 31) {
                alert('D√≠a inv√°lido.');
                return;
            }
            if (!ruta) {
                alert('Ruta vac√≠a.');
                return;
            }
            if (!kmRec || kmRec < 1 || kmRec > 999) {
                alert('KM recorridos inv√°lidos. (1-999)');
                return;
            }

            if (kmIni && kmInicialDelMes === 0) {
                kmInicialDelMes = kmIni;
            }

            const existe = registros.find(r => r.dia === dia);
            if (existe) {
                if (!confirm('Ya existe un registro para este d√≠a. ¬øReemplazarlo?')) return;
                registros = registros.filter(r => r.dia !== dia);
            }

            registros.push({
                dia: dia,
                ruta: ruta,
                kmRecorridos: kmRec
            });
            registros.sort((a, b) => a.dia - b.dia);

            document.getElementById('dia').value = '';
            document.getElementById('ruta').value = '';
            document.getElementById('kmRecorridos').value = '';
            document.getElementById('kmFinalHoy').value = '';

            actualizarTabla();
            actualizarResumen();
            guardarDatos();
        }

        function actualizarTabla() {
            const cuerpo = document.getElementById('cuerpoTabla');
            cuerpo.innerHTML = '';
            let kmAc = kmInicialDelMes;
            registros.forEach((r, i) => {
                kmAc += r.kmRecorridos;
                cuerpo.innerHTML += `<tr><td>${r.dia}</td><td style="text-align:left;padding-left:15px;">${r.ruta}</td><td class="number">${formatNumber(r.kmRecorridos)} km</td><td class="number">${formatNumber(kmAc)} km</td><td><button class="small-btn btn-edit" data-index="${i}">Editar</button><button class="small-btn btn-delete" data-index="${i}">Eliminar</button></td></tr>`;
            });
            if (registros.length > 0) {
                const tot = registros.reduce((s, r) => s + r.kmRecorridos, 0);
                cuerpo.innerHTML += `<tr class="total-row"><td><strong>TOTALES</strong></td><td><strong>${registros.length} viajes registrados</strong></td><td class="number"><strong>${formatNumber(tot)} km</strong></td><td class="number"><strong>${formatNumber(kmInicialDelMes+tot)} km</strong></td><td></td></tr>`;
            }
        }

        function editarRegistro(index) {
            const r = registros[index];
            document.getElementById('dia').value = r.dia;
            document.getElementById('ruta').value = r.ruta;
            document.getElementById('kmRecorridos').value = formatNumber(r.kmRecorridos);
            registros.splice(index, 1);
            actualizarTabla();
            actualizarResumen();
            guardarDatos();
        }

        function eliminarRegistro(index) {
            if (!confirm('¬øEliminar este registro?')) return;
            registros.splice(index, 1);
            actualizarTabla();
            actualizarResumen();
            guardarDatos();
        }

        function actualizarResumen() {
            const tot = registros.reduce((s, r) => s + r.kmRecorridos, 0);
            document.getElementById('totalKmMes').textContent = formatNumber(tot) + ' km';
            document.getElementById('kmInicialMes').textContent = formatNumber(kmInicialDelMes) + ' km';
            document.getElementById('kmFinalMes').textContent = formatNumber(kmInicialDelMes + tot) + ' km';
            document.getElementById('numeroViajes').textContent = registros.length;
        }

        function limpiarTabla() {
            if (registros.length === 0 && kmInicialDelMes === 0 && !document.getElementById('kmInicial').value) {
                alert('No hay registros o datos iniciales para limpiar.');
                return;
            }

            if (confirm('¬øSeguro de limpiar todo?')) {
                registros = [];
                kmInicialDelMes = 0;
                
                // Reiniciamos los campos de entrada
                document.getElementById('mesAnio').value = new Date().toISOString().slice(0, 7);
                document.getElementById('kmInicial').value = '';
                document.getElementById('kmFinalHoy').value = '';
                document.getElementById('dia').value = '';
                document.getElementById('ruta').value = '';
                document.getElementById('kmRecorridos').value = '';
                
                localStorage.removeItem('controlKmData');
                actualizarTabla();
                actualizarResumen();

                const alert = document.getElementById('loadAlert');
                alert.textContent = 'üóëÔ∏è Datos eliminados del navegador.';
                alert.style.backgroundColor = '#f8d7da';
                alert.style.color = '#721c24';
                alert.style.borderLeftColor = '#dc3545';
                alert.style.display = 'block';
                setTimeout(() => {
                    alert.style.display = 'none';
                    alert.style.backgroundColor = '';
                    alert.style.color = '';
                    alert.style.borderLeftColor = '';
                }, 3000);
            }
        }

        document.getElementById('cuerpoTabla').addEventListener('click', function(event) {
            const target = event.target;
            if (target.classList.contains('btn-edit')) {
                const index = target.dataset.index;
                editarRegistro(index);
            } else if (target.classList.contains('btn-delete')) {
                const index = target.dataset.index;
                eliminarRegistro(index);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
            if (document.getElementById('mesAnio').value === '') {
                document.getElementById('mesAnio').value = new Date().toISOString().slice(0, 7);
            }
        });
    </script>
</body>
</html>
